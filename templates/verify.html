// static/verify.js

(function() {
  const typedEl = document.getElementById("typed");
  const challengeEl = document.getElementById("challenge");
  const msgEl = document.getElementById("msg");
  const reasonBox = document.getElementById("reasonBox");
  const reasonEl = document.getElementById("reason");

  let dna = { typing: [], mouse: [] };

  // collect typing patterns
  typedEl.addEventListener("keydown", e => {
    dna.typing.push({ key: e.key, t: Date.now() });
  });

  // collect mouse movements
  document.addEventListener("mousemove", e => {
    dna.mouse.push({ x: e.clientX, y: e.clientY, t: Date.now() });
  });

  // submit once they typed code correctly
  typedEl.addEventListener("input", async () => {
    if (typedEl.value.trim().toUpperCase() === challengeEl.innerText.trim().toUpperCase()) {
      msgEl.innerHTML = "Submitting… <span id='spinner'></span>";
      await submitVerification();
      pollStatus();
    }
  });

  async function submitVerification() {
    try {
      const res = await fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: window.AEGIS_TOKEN,
          fp: navigator.userAgent,
          dna,
          honeypot: false
        })
      });
      const data = await res.json();
      if (!data.ok) {
        msgEl.innerHTML = "❌ Failed to submit";
        reasonBox.style.display = "block";
        reasonEl.innerText = data.error || "Unknown error";
      } else {
        msgEl.innerHTML = "✅ Submitted, waiting for result…";
      }
    } catch (err) {
      msgEl.innerHTML = "❌ Network error";
    }
  }

  async function pollStatus() {
    let tries = 0;
    const timer = setInterval(async () => {
      tries++;
      try {
        const res = await fetch(`/status/${window.AEGIS_TOKEN}`);
        const data = await res.json();
        if (data.ok && data.status !== "pending") {
          clearInterval(timer);
          if (data.status === "verified") {
            msgEl.innerHTML = "✅ Verification successful!";
          } else {
            msgEl.innerHTML = "❌ Verification failed.";
          }
          reasonBox.style.display = "block";
          reasonEl.innerText = `Status: ${data.status}\nUsed: ${data.used}`;
        }
      } catch (e) {
        clearInterval(timer);
        msgEl.innerHTML = "❌ Error checking status";
      }
      if (tries > 20) { // stop after ~20s
        clearInterval(timer);
        msgEl.innerHTML = "❌ Timed out. Please try again.";
      }
    }, 1000);
  }

})();
